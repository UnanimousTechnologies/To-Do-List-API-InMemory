<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>FastAPI To-Do</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    .task { padding: 10px; border: 1px solid #ddd; margin: 8px 0; border-radius: 6px; display:flex; justify-content:space-between; align-items:center }
    .done { text-decoration: line-through; color: gray; }
    button { margin-left: 6px; }
    input { padding: 6px; margin-right: 6px; }
  </style>
</head>
<body>
  <h1>To-Do (FastAPI)</h1>

  <div>
    <input id="title" placeholder="Task title" />
    <input id="description" placeholder="Task description" />
    <button id="addBtn">Add Task</button>
  </div>

  <h2>Tasks</h2>
  <div id="tasks"></div>

  <script>
    const API_URL = "http://127.0.0.1:8000/tasks/";

    async function loadTasks() {
      try {
        const res = await fetch(API_URL);
        if (!res.ok) {
          console.error("Fetch /tasks/ failed", res.status);
          document.getElementById("tasks").innerText = "Error loading tasks (check console).";
          return;
        }
        const tasks = await res.json();
        const container = document.getElementById("tasks");
        container.innerHTML = "";
        tasks.forEach(task => {
          const div = document.createElement("div");
          div.className = "task";

          const left = document.createElement("div");
          left.innerHTML = `<strong class="${task.done ? "done" : ""}">${escapeHtml(task.title)}</strong>
                            <div>${escapeHtml(task.description || "")}</div>`;

          const right = document.createElement("div");

          const toggleBtn = document.createElement("button");
          toggleBtn.textContent = task.done ? "Undo" : "Done";
          toggleBtn.onclick = () => toggleTask(task.id, task.done);

          const delBtn = document.createElement("button");
          delBtn.textContent = "Delete";
          delBtn.onclick = () => deleteTask(task.id);

          right.appendChild(toggleBtn);
          right.appendChild(delBtn);

          div.appendChild(left);
          div.appendChild(right);
          container.appendChild(div);
        });
      } catch (err) {
        console.error("loadTasks error", err);
        document.getElementById("tasks").innerText = "Network error (check console).";
      }
    }

    async function addTask() {
      const title = document.getElementById("title").value.trim();
      const description = document.getElementById("description").value.trim();

      if (!title) { alert("Title required"); return; }

      try {
        const res = await fetch(API_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ title, description, done: false })
        });
        if (!res.ok) {
          const text = await res.text();
          console.error("POST /tasks/ failed", res.status, text);
          alert("Failed to add task (see console).");
          return;
        }
        document.getElementById("title").value = "";
        document.getElementById("description").value = "";
        await loadTasks();
      } catch (err) {
        console.error("addTask error", err);
        alert("Network error (see console).");
      }
    }

    async function toggleTask(id, done) {
      try {
        const res = await fetch(`${API_URL}${id}`, {
          method: "PATCH",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ done: !done })
        });
        if (!res.ok) {
          console.error("PATCH failed", res.status);
        }
        loadTasks();
      } catch (err) {
        console.error("toggleTask error", err);
      }
    }

    async function deleteTask(id) {
      try {
        const res = await fetch(`${API_URL}${id}`, { method: "DELETE" });
        if (!res.ok) console.error("DELETE failed", res.status);
        loadTasks();
      } catch (err) {
        console.error("deleteTask error", err);
      }
    }

    // basic HTML escaping
    function escapeHtml(text) {
      return text
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;");
    }

    document.getElementById("addBtn").addEventListener("click", addTask);

    // start
    loadTasks();
  </script>
</body>
</html>
